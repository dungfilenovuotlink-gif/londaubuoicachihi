local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Tạo GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "NPCAssist"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = player.PlayerGui

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 220, 0, 200)
MainFrame.Position = UDim2.new(0, 10, 0, 10)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

local UIStroke = Instance.new("UIStroke")
UIStroke.Color = Color3.fromRGB(60, 60, 70)
UIStroke.Thickness = 2
UIStroke.Parent = MainFrame

-- Tiêu đề
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 25)
Title.Position = UDim2.new(0, 0, 0, 0)
Title.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
Title.TextColor3 = Color3.fromRGB(220, 220, 220)
Title.Text = "NPC Assist v2"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 12
Title.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 8)
TitleCorner.Parent = Title

-- Toggle Fly
local FlyToggle = Instance.new("TextButton")
FlyToggle.Size = UDim2.new(0.9, 0, 0, 25)
FlyToggle.Position = UDim2.new(0.05, 0, 0.18, 0)
FlyToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
FlyToggle.TextColor3 = Color3.fromRGB(220, 220, 220)
FlyToggle.Text = "FLY: OFF"
FlyToggle.Font = Enum.Font.Gotham
FlyToggle.TextSize = 11
FlyToggle.Parent = MainFrame

local FlyCorner = Instance.new("UICorner")
FlyCorner.CornerRadius = UDim.new(0, 6)
FlyCorner.Parent = FlyToggle

-- Textbox độ cao
local HeightBox = Instance.new("TextBox")
HeightBox.Size = UDim2.new(0.4, 0, 0, 25)
HeightBox.Position = UDim2.new(0.05, 0, 0.35, 0)
HeightBox.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
HeightBox.TextColor3 = Color3.fromRGB(220, 220, 220)
HeightBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
HeightBox.PlaceholderText = "Độ cao"
HeightBox.Text = "10"
HeightBox.Font = Enum.Font.Gotham
HeightBox.TextSize = 11
HeightBox.Parent = MainFrame

local HeightCorner = Instance.new("UICorner")
HeightCorner.CornerRadius = UDim.new(0, 6)
HeightCorner.Parent = HeightBox

-- Label độ cao
local HeightLabel = Instance.new("TextLabel")
HeightLabel.Size = UDim2.new(0.5, 0, 0, 25)
HeightLabel.Position = UDim2.new(0.5, 0, 0.35, 0)
HeightLabel.BackgroundTransparency = 1
HeightLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
HeightLabel.Text = "Studs"
HeightLabel.Font = Enum.Font.Gotham
HeightLabel.TextSize = 10
HeightLabel.TextXAlignment = Enum.TextXAlignment.Left
HeightLabel.Parent = MainFrame

-- Toggle Auto Tool
local ToolToggle = Instance.new("TextButton")
ToolToggle.Size = UDim2.new(0.9, 0, 0, 25)
ToolToggle.Position = UDim2.new(0.05, 0, 0.52, 0)
ToolToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
ToolToggle.TextColor3 = Color3.fromRGB(220, 220, 220)
ToolToggle.Text = "AUTO TOOL: OFF"
ToolToggle.Font = Enum.Font.Gotham
ToolToggle.TextSize = 11
ToolToggle.Parent = MainFrame

local ToolCorner = Instance.new("UICorner")
ToolCorner.CornerRadius = UDim.new(0, 6)
ToolCorner.Parent = ToolToggle

-- Toggle Áp chế NPC
local CrushToggle = Instance.new("TextButton")
CrushToggle.Size = UDim2.new(0.9, 0, 0, 25)
CrushToggle.Position = UDim2.new(0.05, 0, 0.69, 0)
CrushToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
CrushToggle.TextColor3 = Color3.fromRGB(220, 220, 220)
CrushToggle.Text = "ÁP CHẾ NPC: OFF"
CrushToggle.Font = Enum.Font.Gotham
CrushToggle.TextSize = 11
CrushToggle.Parent = MainFrame

local CrushCorner = Instance.new("UICorner")
CrushCorner.CornerRadius = UDim.new(0, 6)
CrushCorner.Parent = CrushToggle

-- Status Label
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(0.9, 0, 0, 25)
StatusLabel.Position = UDim2.new(0.05, 0, 0.86, 0)
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
StatusLabel.Text = "Đang chờ..."
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 10
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.Parent = MainFrame

-- Biến điều khiển
local isFlying = false
local isAutoTool = false
local isCrushing = false
local currentHeight = 10
local flyConnection = nil
local toolConnection = nil
local crushConnection = nil

-- Hiệu ứng hover cho buttons
local function setupButtonHover(button)
    button.MouseEnter:Connect(function()
        if button == FlyToggle and not isFlying then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 65)}):Play()
        elseif button == ToolToggle and not isAutoTool then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 65)}):Play()
        elseif button == CrushToggle and not isCrushing then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 65)}):Play()
        end
    end)
    
    button.MouseLeave:Connect(function()
        if button == FlyToggle and not isFlying then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 50, 55)}):Play()
        elseif button == ToolToggle and not isAutoTool then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 50, 55)}):Play()
        elseif button == CrushToggle and not isCrushing then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 50, 55)}):Play()
        end
    end)
end

setupButtonHover(FlyToggle)
setupButtonHover(ToolToggle)
setupButtonHover(CrushToggle)

-- Hàm tìm boss
function findNearestNPC()
    local npcsFolder = workspace:FindFirstChild("GiangHo2")
    if not npcsFolder then 
        StatusLabel.Text = "Không tìm thấy GiangHo2"
        return nil 
    end
    
    npcsFolder = npcsFolder:FindFirstChild("NPCs")
    if not npcsFolder then 
        StatusLabel.Text = "Không tìm thấy NPCs"
        return nil 
    end
    
    local nearestNPC = nil
    local nearestDistance = math.huge
    
    for _, npc in pairs(npcsFolder:GetChildren()) do
        if npc:IsA("Model") then
            local npcRoot = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("Head") or npc:FindFirstChild("Torso")
            if npcRoot and humanoidRootPart then
                local distance = (npcRoot.Position - humanoidRootPart.Position).Magnitude
                if distance < nearestDistance then
                    nearestDistance = distance
                    nearestNPC = npc
                end
            end
        end
    end
    
    if nearestNPC then
        StatusLabel.Text = "Đã tìm thấy NPC"
    else
        StatusLabel.Text = "Không tìm thấy NPC"
    end
    
    return nearestNPC
end

-- Hàm lấy tool
function getTool()
    if not character then return nil end
    for _, tool in pairs(character:GetChildren()) do
        if tool:IsA("Tool") then
            return tool
        end
    end
    return nil
end

-- Hàm bay lên đầu NPC
function flyAboveNPC()
    local npc = findNearestNPC()
    if not npc then 
        StatusLabel.Text = "Không tìm thấy NPC"
        return false 
    end
    
    local npcRoot = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("Head") or npc:FindFirstChild("Torso")
    if not npcRoot then 
        StatusLabel.Text = "NPC không có root part"
        return false 
    end
    
    if not humanoidRootPart then 
        StatusLabel.Text = "Không có HumanoidRootPart"
        return false 
    end

    -- Cập nhật độ cao từ textbox
    local newHeight = tonumber(HeightBox.Text)
    if newHeight and newHeight > 0 then
        currentHeight = newHeight
    else
        HeightBox.Text = tostring(currentHeight)
    end
    
    local targetPosition = npcRoot.Position + Vector3.new(0, currentHeight, 0)
    
    -- Di chuyển và aim xuống NPC
    humanoidRootPart.CFrame = CFrame.new(targetPosition, npcRoot.Position)
    StatusLabel.Text = "Đang bay..."
    return true
end

-- Hàm sử dụng tool tự động
function useToolAutomatically()
    local tool = getTool()
    if tool then
        tool:Activate()
    end
end

-- Hàm áp chế NPC (làm NPC lún xuống)
function crushNPC()
    local npc = findNearestNPC()
    if not npc then 
        StatusLabel.Text = "Không tìm thấy NPC để áp chế"
        return false 
    end
    
    local npcRoot = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("Head") or npc:FindFirstChild("Torso")
    if not npcRoot then 
        StatusLabel.Text = "NPC không có root part"
        return false 
    end
    
    -- Tạo lực đẩy NPC xuống đất
    local bodyVelocity = npcRoot:FindFirstChild("CrushVelocity")
    if not bodyVelocity then
        bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.Name = "CrushVelocity"
        bodyVelocity.MaxForce = Vector3.new(4000, 4000, 4000)
        bodyVelocity.Velocity = Vector3.new(0, -50, 0) -- Lực đẩy xuống mạnh
        bodyVelocity.Parent = npcRoot
    else
        bodyVelocity.Velocity = Vector3.new(0, -50, 0)
    end
    
    -- Thêm BodyForce để tăng hiệu ứng lún
    local bodyForce = npcRoot:FindFirstChild("CrushForce")
    if not bodyForce then
        bodyForce = Instance.new("BodyForce")
        bodyForce.Name = "CrushForce"
        bodyForce.Force = Vector3.new(0, -1000, 0) -- Lực hướng xuống
        bodyForce.Parent = npcRoot
    end
    
    StatusLabel.Text = "Đang áp chế NPC..."
    return true
end

-- Hàm dừng áp chế NPC
function stopCrushingNPC()
    local npc = findNearestNPC()
    if npc then
        local npcRoot = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("Head") or npc:FindFirstChild("Torso")
        if npcRoot then
            local bodyVelocity = npcRoot:FindFirstChild("CrushVelocity")
            local bodyForce = npcRoot:FindFirstChild("CrushForce")
            
            if bodyVelocity then
                bodyVelocity:Destroy()
            end
            if bodyForce then
                bodyForce:Destroy()
            end
        end
    end
end

-- Hàm bắt đầu bay
function startFlying()
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    
    flyConnection = RunService.Heartbeat:Connect(function()
        local success = flyAboveNPC()
        if not success then
            StatusLabel.Text = "Lỗi khi bay"
        end
    end)
end

-- Hàm dừng bay
function stopFlying()
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    StatusLabel.Text = "Đã dừng bay"
end

-- Hàm bắt đầu áp chế
function startCrushing()
    if crushConnection then
        crushConnection:Disconnect()
        crushConnection = nil
    end
    
    crushConnection = RunService.Heartbeat:Connect(function()
        local success = crushNPC()
        if not success then
            StatusLabel.Text = "Lỗi khi áp chế"
        end
    end)
end

-- Hàm dừng áp chế
function stopCrushing()
    if crushConnection then
        crushConnection:Disconnect()
        crushConnection = nil
    end
    stopCrushingNPC()
    StatusLabel.Text = "Đã dừng áp chế"
end

-- Sự kiện Fly Toggle
FlyToggle.MouseButton1Click:Connect(function()
    isFlying = not isFlying
    
    if isFlying then
        -- Bật fly
        local success = pcall(function()
            FlyToggle.BackgroundColor3 = Color3.fromRGB(0, 120, 60)
            FlyToggle.Text = "FLY: ON"
            startFlying()
        end)
        
        if not success then
            isFlying = false
            FlyToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
            FlyToggle.Text = "FLY: OFF"
            StatusLabel.Text = "Lỗi khi bật fly"
        end
    else
        -- Tắt fly
        FlyToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        FlyToggle.Text = "FLY: OFF"
        stopFlying()
    end
end)

-- Sự kiện Auto Tool Toggle
ToolToggle.MouseButton1Click:Connect(function()
    isAutoTool = not isAutoTool
    
    if isAutoTool then
        -- Bật auto tool
        ToolToggle.BackgroundColor3 = Color3.fromRGB(0, 100, 180)
        ToolToggle.Text = "AUTO TOOL: ON"
        
        if isFlying and not toolConnection then
            toolConnection = RunService.Heartbeat:Connect(function()
                useToolAutomatically()
            end)
        end
    else
        -- Tắt auto tool
        ToolToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        ToolToggle.Text = "AUTO TOOL: OFF"
        
        if toolConnection then
            toolConnection:Disconnect()
            toolConnection = nil
        end
    end
end)

-- Sự kiện Áp chế Toggle
CrushToggle.MouseButton1Click:Connect(function()
    isCrushing = not isCrushing
    
    if isCrushing then
        -- Bật áp chế
        local success = pcall(function()
            CrushToggle.BackgroundColor3 = Color3.fromRGB(180, 60, 0)
            CrushToggle.Text = "ÁP CHẾ NPC: ON"
            startCrushing()
        end)
        
        if not success then
            isCrushing = false
            CrushToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
            CrushToggle.Text = "ÁP CHẾ NPC: OFF"
            StatusLabel.Text = "Lỗi khi bật áp chế"
        end
    else
        -- Tắt áp chế
        CrushToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        CrushToggle.Text = "ÁP CHẾ NPC: OFF"
        stopCrushing()
    end
end)

-- Xử lý textbox độ cao
HeightBox.FocusLost:Connect(function(enterPressed)
    local newHeight = tonumber(HeightBox.Text)
    if newHeight and newHeight > 0 and newHeight <= 100 then
        currentHeight = newHeight
        HeightBox.Text = tostring(currentHeight)
    else
        HeightBox.Text = tostring(currentHeight)
    end
end)

-- Xử lý khi character respawn
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    
    -- Reset trạng thái khi respawn
    if isFlying then
        isFlying = false
        FlyToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        FlyToggle.Text = "FLY: OFF"
        stopFlying()
    end
    
    if isAutoTool then
        isAutoTool = false
        ToolToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        ToolToggle.Text = "AUTO TOOL: OFF"
        if toolConnection then
            toolConnection:Disconnect()
            toolConnection = nil
        end
    end
    
    if isCrushing then
        isCrushing = false
        CrushToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        CrushToggle.Text = "ÁP CHẾ NPC: OFF"
        stopCrushing()
    end
end)

-- Kéo GUI
local dragging = false
local dragInput, dragStart, startPos

local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

Title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

Title.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

-- Debug info
print("NPC Assist GUI đã được tạo!")
print("Script đang chạy...")
print("Đường dẫn NPC: workspace.GiangHo2.NPCs")

-- Test tìm NPC
spawn(function()
    wait(2)
    local npc = findNearestNPC()
    if npc then
        print("Tìm thấy NPC:", npc.Name)
        StatusLabel.Text = "Sẵn sàng - Đã tìm thấy NPC"
    else
        print("Không tìm thấy NPC")
        StatusLabel.Text = "Không tìm thấy NPC"
    end
end)
