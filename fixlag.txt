local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Tạo GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "NPCAssist"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = player.PlayerGui

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 220, 0, 230)
MainFrame.Position = UDim2.new(0, 10, 0, 10)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

local UIStroke = Instance.new("UIStroke")
UIStroke.Color = Color3.fromRGB(60, 60, 70)
UIStroke.Thickness = 2
UIStroke.Parent = MainFrame

-- Tiêu đề
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 25)
Title.Position = UDim2.new(0, 0, 0, 0)
Title.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
Title.TextColor3 = Color3.fromRGB(220, 220, 220)
Title.Text = "NPC Assist - STEALTH"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 12
Title.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 8)
TitleCorner.Parent = Title

-- Toggle Fly
local FlyToggle = Instance.new("TextButton")
FlyToggle.Size = UDim2.new(0.9, 0, 0, 25)
FlyToggle.Position = UDim2.new(0.05, 0, 0.15, 0)
FlyToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
FlyToggle.TextColor3 = Color3.fromRGB(220, 220, 220)
FlyToggle.Text = "STEALTH FLY: OFF"
FlyToggle.Font = Enum.Font.Gotham
FlyToggle.TextSize = 11
FlyToggle.Parent = MainFrame

local FlyCorner = Instance.new("UICorner")
FlyCorner.CornerRadius = UDim.new(0, 6)
FlyCorner.Parent = FlyToggle

-- Textbox khoảng cách
local DistanceBox = Instance.new("TextBox")
DistanceBox.Size = UDim2.new(0.4, 0, 0, 25)
DistanceBox.Position = UDim2.new(0.05, 0, 0.32, 0)
DistanceBox.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
DistanceBox.TextColor3 = Color3.fromRGB(220, 220, 220)
DistanceBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
DistanceBox.PlaceholderText = "Khoảng cách"
DistanceBox.Text = "8"
DistanceBox.Font = Enum.Font.Gotham
DistanceBox.TextSize = 11
DistanceBox.Parent = MainFrame

local DistanceCorner = Instance.new("UICorner")
DistanceCorner.CornerRadius = UDim.new(0, 6)
DistanceCorner.Parent = DistanceBox

-- Label khoảng cách
local DistanceLabel = Instance.new("TextLabel")
DistanceLabel.Size = UDim2.new(0.5, 0, 0, 25)
DistanceLabel.Position = UDim2.new(0.5, 0, 0.32, 0)
DistanceLabel.BackgroundTransparency = 1
DistanceLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
DistanceLabel.Text = "Studs"
DistanceLabel.Font = Enum.Font.Gotham
DistanceLabel.TextSize = 10
DistanceLabel.TextXAlignment = Enum.TextXAlignment.Left
DistanceLabel.Parent = MainFrame

-- Textbox tốc độ quay
local SpeedBox = Instance.new("TextBox")
SpeedBox.Size = UDim2.new(0.4, 0, 0, 25)
SpeedBox.Position = UDim2.new(0.05, 0, 0.49, 0)
SpeedBox.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
SpeedBox.TextColor3 = Color3.fromRGB(220, 220, 220)
SpeedBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
SpeedBox.PlaceholderText = "Tốc độ quay"
SpeedBox.Text = "1.5"
SpeedBox.Font = Enum.Font.Gotham
SpeedBox.TextSize = 11
SpeedBox.Parent = MainFrame

local SpeedCorner = Instance.new("UICorner")
SpeedCorner.CornerRadius = UDim.new(0, 6)
SpeedCorner.Parent = SpeedBox

-- Label tốc độ quay
local SpeedLabel = Instance.new("TextLabel")
SpeedLabel.Size = UDim2.new(0.5, 0, 0, 25)
SpeedLabel.Position = UDim2.new(0.5, 0, 0.49, 0)
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
SpeedLabel.Text = "Speed"
SpeedLabel.Font = Enum.Font.Gotham
SpeedLabel.TextSize = 10
SpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
SpeedLabel.Parent = MainFrame

-- Toggle Auto Tool
local ToolToggle = Instance.new("TextButton")
ToolToggle.Size = UDim2.new(0.9, 0, 0, 25)
ToolToggle.Position = UDim2.new(0.05, 0, 0.66, 0)
ToolToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
ToolToggle.TextColor3 = Color3.fromRGB(220, 220, 220)
ToolToggle.Text = "AUTO TOOL: OFF"
ToolToggle.Font = Enum.Font.Gotham
ToolToggle.TextSize = 11
ToolToggle.Parent = MainFrame

local ToolCorner = Instance.new("UICorner")
ToolCorner.CornerRadius = UDim.new(0, 6)
ToolCorner.Parent = ToolToggle

-- Toggle Orbit Mode
local OrbitToggle = Instance.new("TextButton")
OrbitToggle.Size = UDim2.new(0.9, 0, 0, 25)
OrbitToggle.Position = UDim2.new(0.05, 0, 0.83, 0)
OrbitToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
OrbitToggle.TextColor3 = Color3.fromRGB(220, 220, 220)
OrbitToggle.Text = "ORBIT MODE: OFF"
OrbitToggle.Font = Enum.Font.Gotham
OrbitToggle.TextSize = 11
OrbitToggle.Parent = MainFrame

local OrbitCorner = Instance.new("UICorner")
OrbitCorner.CornerRadius = UDim.new(0, 6)
OrbitCorner.Parent = OrbitToggle

-- Biến điều khiển
local isFlying = false
local isAutoTool = false
local isOrbiting = false
local currentDistance = 8
local currentSpeed = 1.5
local flyConnection = nil
local toolConnection = nil
local orbitConnection = nil

-- Hiệu ứng hover cho buttons
local function setupButtonHover(button)
    button.MouseEnter:Connect(function()
        if button == FlyToggle and not isFlying then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 65)}):Play()
        elseif button == ToolToggle and not isAutoTool then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 65)}):Play()
        elseif button == OrbitToggle and not isOrbiting then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 65)}):Play()
        end
    end)
    
    button.MouseLeave:Connect(function()
        if button == FlyToggle and not isFlying then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 50, 55)}):Play()
        elseif button == ToolToggle and not isAutoTool then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 50, 55)}):Play()
        elseif button == OrbitToggle and not isOrbiting then
            TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 50, 55)}):Play()
        end
    end)
end

setupButtonHover(FlyToggle)
setupButtonHover(ToolToggle)
setupButtonHover(OrbitToggle)

-- Hàm tìm boss
function findNearestNPC()
    local npcsFolder = workspace:FindFirstChild("GiangHo2")
    if not npcsFolder then 
        StatusLabel.Text = "Không tìm thấy GiangHo2"
        return nil 
    end
    
    npcsFolder = npcsFolder:FindFirstChild("NPCs")
    if not npcsFolder then 
        StatusLabel.Text = "Không tìm thấy NPCs"
        return nil 
    end
    
    local nearestNPC = nil
    local nearestDistance = math.huge
    
    for _, npc in pairs(npcsFolder:GetChildren()) do
        if npc:IsA("Model") then
            local npcRoot = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("Head") or npc:FindFirstChild("Torso")
            if npcRoot and humanoidRootPart then
                local distance = (npcRoot.Position - humanoidRootPart.Position).Magnitude
                if distance < nearestDistance then
                    nearestDistance = distance
                    nearestNPC = npc
                end
            end
        end
    end
    
    if nearestNPC then
        StatusLabel.Text = "Đã tìm thấy NPC"
    else
        StatusLabel.Text = "Không tìm thấy NPC"
    end
    
    return nearestNPC
end

-- Hàm lấy tool
function getTool()
    if not character then return nil end
    for _, tool in pairs(character:GetChildren()) do
        if tool:IsA("Tool") then
            return tool
        end
    end
    return nil
end

-- Hàm di chuyển stealth (tránh anti-cheat)
function stealthMoveToPosition(targetPosition)
    if not humanoidRootPart then return false end
    
    -- Tính vector di chuyển
    local direction = (targetPosition - humanoidRootPart.Position)
    local distance = direction.Magnitude
    
    -- Nếu quá gần thì không di chuyển
    if distance < 2 then
        return true
    end
    
    -- Giới hạn tốc độ di chuyển để trông tự nhiên
    local maxSpeed = 25
    if distance > 10 then
        direction = direction.Unit * math.min(distance, maxSpeed)
    else
        direction = direction.Unit * (distance * 0.5) -- Di chuyển chậm khi gần
    end
    
    -- Sử dụng Humanoid thay vì trực tiếp set CFrame
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        -- Giả lập movement bằng cách set velocity một cách tự nhiên
        humanoidRootPart.Velocity = direction
        
        -- Xoay character về phía NPC
        local npc = findNearestNPC()
        if npc then
            local npcRoot = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("Head") or npc:FindFirstChild("Torso")
            if npcRoot then
                humanoidRootPart.CFrame = CFrame.new(humanoidRootPart.Position, Vector3.new(npcRoot.Position.X, humanoidRootPart.Position.Y, npcRoot.Position.Z))
            end
        end
    end
    
    return true
end

-- Hàm bay stealth (orbit quanh NPC thay vì lên đầu)
function stealthOrbitNPC()
    local npc = findNearestNPC()
    if not npc then 
        StatusLabel.Text = "Không tìm thấy NPC"
        return false 
    end
    
    local npcRoot = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("Head") or npc:FindFirstChild("Torso")
    if not npcRoot then 
        StatusLabel.Text = "NPC không có root part"
        return false 
    end
    
    if not humanoidRootPart then 
        StatusLabel.Text = "Không có HumanoidRootPart"
        return false 
    end

    -- Cập nhật khoảng cách từ textbox
    local newDistance = tonumber(DistanceBox.Text)
    if newDistance and newDistance > 0 then
        currentDistance = newDistance
    else
        DistanceBox.Text = tostring(currentDistance)
    end
    
    -- Cập nhật tốc độ từ textbox
    local newSpeed = tonumber(SpeedBox.Text)
    if newSpeed and newSpeed > 0 then
        currentSpeed = newSpeed
    else
        SpeedBox.Text = tostring(currentSpeed)
    end
    
    if isOrbiting then
        -- Chế độ orbit: bay vòng quanh NPC với tốc độ có thể chỉnh
        local angle = tick() * currentSpeed -- Tốc độ orbit có thể chỉnh
        local offset = Vector3.new(math.cos(angle) * currentDistance, 3, math.sin(angle) * currentDistance) -- Cao hơn NPC 3 studs
        local targetPosition = npcRoot.Position + offset
        
        stealthMoveToPosition(targetPosition)
        StatusLabel.Text = "Đang orbit... Tốc độ: " .. currentSpeed
    else
        -- Chế độ thường: đứng ở khoảng cách an toàn
        local direction = (humanoidRootPart.Position - npcRoot.Position).Unit
        local targetPosition = npcRoot.Position + (direction * currentDistance)
        targetPosition = Vector3.new(targetPosition.X, npcRoot.Position.Y + 2, targetPosition.Z) -- Cao hơn một chút
        
        stealthMoveToPosition(targetPosition)
        StatusLabel.Text = "Đang giữ khoảng cách..."
    end
    
    return true
end

-- Hàm sử dụng tool tự động
function useToolAutomatically()
    local tool = getTool()
    if tool then
        -- Sử dụng tool với delay ngẫu nhiên để tránh bị phát hiện
        if math.random(1, 3) == 1 then -- Chỉ kích hoạt 1/3 thời gian
            tool:Activate()
        end
    end
end

-- Hàm bắt đầu bay stealth
function startStealthFlying()
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    
    flyConnection = RunService.Heartbeat:Connect(function()
        -- Thêm delay ngẫu nhiên để movement trông tự nhiên hơn
        if math.random(1, 2) == 1 then
            local success = stealthOrbitNPC()
            if not success then
                StatusLabel.Text = "Lỗi khi bay"
            end
        end
    end)
end

-- Hàm dừng bay
function stopStealthFlying()
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    
    -- Reset velocity khi dừng
    if humanoidRootPart then
        humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
    end
    
    StatusLabel.Text = "Đã dừng bay"
end

-- Sự kiện Fly Toggle
FlyToggle.MouseButton1Click:Connect(function()
    isFlying = not isFlying
    
    if isFlying then
        -- Bật fly stealth
        local success = pcall(function()
            FlyToggle.BackgroundColor3 = Color3.fromRGB(0, 120, 60)
            FlyToggle.Text = "STEALTH FLY: ON"
            startStealthFlying()
        end)
        
        if not success then
            isFlying = false
            FlyToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
            FlyToggle.Text = "STEALTH FLY: OFF"
            StatusLabel.Text = "Lỗi khi bật fly"
        end
    else
        -- Tắt fly
        FlyToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        FlyToggle.Text = "STEALTH FLY: OFF"
        stopStealthFlying()
    end
end)

-- Sự kiện Auto Tool Toggle
ToolToggle.MouseButton1Click:Connect(function()
    isAutoTool = not isAutoTool
    
    if isAutoTool then
        -- Bật auto tool
        ToolToggle.BackgroundColor3 = Color3.fromRGB(0, 100, 180)
        ToolToggle.Text = "AUTO TOOL: ON"
        
        if isFlying and not toolConnection then
            toolConnection = RunService.Heartbeat:Connect(function()
                -- Sử dụng tool với xác suất thấp hơn để stealth
                if math.random(1, 4) == 1 then
                    useToolAutomatically()
                end
            end)
        end
    else
        -- Tắt auto tool
        ToolToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        ToolToggle.Text = "AUTO TOOL: OFF"
        
        if toolConnection then
            toolConnection:Disconnect()
            toolConnection = nil
        end
    end
end)

-- Sự kiện Orbit Toggle
OrbitToggle.MouseButton1Click:Connect(function()
    isOrbiting = not isOrbiting
    
    if isOrbiting then
        -- Bật orbit mode
        OrbitToggle.BackgroundColor3 = Color3.fromRGB(120, 0, 180)
        OrbitToggle.Text = "ORBIT MODE: ON"
        StatusLabel.Text = "Đã bật chế độ orbit"
    else
        -- Tắt orbit mode
        OrbitToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        OrbitToggle.Text = "ORBIT MODE: OFF"
        StatusLabel.Text = "Đã tắt chế độ orbit"
    end
end)

-- Xử lý textbox khoảng cách
DistanceBox.FocusLost:Connect(function(enterPressed)
    local newDistance = tonumber(DistanceBox.Text)
    if newDistance and newDistance >= 5 and newDistance <= 20 then
        currentDistance = newDistance
        DistanceBox.Text = tostring(currentDistance)
        StatusLabel.Text = "Khoảng cách: " .. currentDistance .. " studs"
    else
        DistanceBox.Text = tostring(currentDistance)
        StatusLabel.Text = "Khoảng cách phải từ 5-20"
    end
end)

-- Xử lý textbox tốc độ quay
SpeedBox.FocusLost:Connect(function(enterPressed)
    local newSpeed = tonumber(SpeedBox.Text)
    if newSpeed and newSpeed >= 0.1 and newSpeed <= 5 then
        currentSpeed = newSpeed
        SpeedBox.Text = tostring(currentSpeed)
        StatusLabel.Text = "Tốc độ quay: " .. currentSpeed
    else
        SpeedBox.Text = tostring(currentSpeed)
        StatusLabel.Text = "Tốc độ phải từ 0.1-5"
    end
end)

-- Xử lý khi character respawn
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    
    -- Reset trạng thái khi respawn
    if isFlying then
        isFlying = false
        FlyToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        FlyToggle.Text = "STEALTH FLY: OFF"
        stopStealthFlying()
    end
    
    if isAutoTool then
        isAutoTool = false
        ToolToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        ToolToggle.Text = "AUTO TOOL: OFF"
        if toolConnection then
            toolConnection:Disconnect()
            toolConnection = nil
        end
    end
    
    if isOrbiting then
        isOrbiting = false
        OrbitToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        OrbitToggle.Text = "ORBIT MODE: OFF"
    end
end)

-- Kéo GUI
local dragging = false
local dragInput, dragStart, startPos

local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

Title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

Title.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

-- Debug info
print("NPC Assist STEALTH đã được tạo!")
print("Bypass anti-cheat activated")
print("Đường dẫn NPC: workspace.GiangHo2.NPCs")

-- Test tìm NPC
spawn(function()
    wait(2)
    local npc = findNearestNPC()
    if npc then
        print("Tìm thấy NPC:", npc.Name)
        StatusLabel.Text = "STEALTH READY - Đã tìm thấy NPC"
    else
        print("Không tìm thấy NPC")
        StatusLabel.Text = "Không tìm thấy NPC"
    end
end)
