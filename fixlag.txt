local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Tạo GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = player.PlayerGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 300, 0, 200)
Frame.Position = UDim2.new(0, 10, 0, 10)
Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui

-- Tiêu đề
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 30)
Title.Position = UDim2.new(0, 0, 0, 0)
Title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Text = "NPC Controller"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 14
Title.Parent = Frame

-- Nút bay lên
local FlyButton = Instance.new("TextButton")
FlyButton.Size = UDim2.new(0.9, 0, 0, 30)
FlyButton.Position = UDim2.new(0.05, 0, 0.2, 0)
FlyButton.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
FlyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
FlyButton.Text = "Bay lên đầu NPCs"
FlyButton.Font = Enum.Font.Gotham
FlyButton.TextSize = 12
FlyButton.Parent = Frame

-- Thanh trượt độ cao
local HeightLabel = Instance.new("TextLabel")
HeightLabel.Size = UDim2.new(0.9, 0, 0, 20)
HeightLabel.Position = UDim2.new(0.05, 0, 0.4, 0)
HeightLabel.BackgroundTransparency = 1
HeightLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
HeightLabel.Text = "Độ cao: 10"
HeightLabel.Font = Enum.Font.Gotham
HeightLabel.TextSize = 12
HeightLabel.TextXAlignment = Enum.TextXAlignment.Left
HeightLabel.Parent = Frame

local HeightSlider = Instance.new("SliderGui")
HeightSlider.Size = UDim2.new(0.9, 0, 0, 20)
HeightSlider.Position = UDim2.new(0.05, 0, 0.55, 0)
HeightSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
HeightSlider.BorderSizePixel = 0
HeightSlider.Parent = Frame

local SliderBar = Instance.new("Frame")
SliderBar.Size = UDim2.new(0.5, 0, 1, 0)
SliderBar.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
SliderBar.BorderSizePixel = 0
SliderBar.Parent = HeightSlider

local SliderButton = Instance.new("TextButton")
SliderButton.Size = UDim2.new(0, 20, 1, 0)
SliderButton.Position = UDim2.new(0.5, -10, 0, 0)
SliderButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
SliderButton.Text = ""
SliderButton.Parent = HeightSlider

-- Toggle Auto Tool
local AutoToolToggle = Instance.new("TextButton")
AutoToolToggle.Size = UDim2.new(0.9, 0, 0, 30)
AutoToolToggle.Position = UDim2.new(0.05, 0, 0.75, 0)
AutoToolToggle.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
AutoToolToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
AutoToolToggle.Text = "Auto Tool: TẮT"
AutoToolToggle.Font = Enum.Font.Gotham
AutoToolToggle.TextSize = 12
AutoToolToggle.Parent = Frame

-- Biến điều khiển
local isFlying = false
local currentHeight = 10
local isAutoToolEnabled = false
local flyConnection = nil
local autoToolConnection = nil

-- Hàm tìm NPC gần nhất
function findNearestNPC()
    local npcsFolder = workspace:FindFirstChild("giangho2")
    if not npcsFolder then return nil end
    
    npcsFolder = npcsFolder:FindFirstChild("npcs")
    if not npcsFolder then return nil end
    
    local nearestNPC = nil
    local nearestDistance = math.huge
    
    for _, npc in pairs(npcsFolder:GetChildren()) do
        local humanoidRootPart = npc:FindFirstChild("HumanoidRootPart")
        if humanoidRootPart then
            local distance = (humanoidRootPart.Position - humanoidRootPart.Position).Magnitude
            if distance < nearestDistance then
                nearestDistance = distance
                nearestNPC = npc
            end
        end
    end
    
    return nearestNPC
end

-- Hàm bay đến NPC
function flyToNPC()
    local npc = findNearestNPC()
    if not npc then return end
    
    local npcRoot = npc:FindFirstChild("HumanoidRootPart")
    if not npcRoot then return end
    
    local targetPosition = npcRoot.Position + Vector3.new(0, currentHeight, 0)
    
    -- Di chuyển nhân vật
    humanoidRootPart.CFrame = CFrame.new(targetPosition)
    
    -- Aim xuống NPC
    humanoidRootPart.CFrame = CFrame.new(targetPosition, npcRoot.Position)
end

-- Hàm sử dụng tool tự động
function useToolAutomatically()
    local tool = character:FindFirstChildOfClass("Tool")
    if tool then
        -- Kích hoạt tool (giả sử tool có remote event hoặc function)
        local handle = tool:FindFirstChild("Handle")
        if handle then
            -- Đây là nơi bạn sẽ thêm logic kích hoạt tool cụ thể
            -- Tùy thuộc vào cách tool được thiết kế
            print("Đang sử dụng tool: " .. tool.Name)
        end
    end
end

-- Sự kiện cho thanh trượt độ cao
local isDragging = false

SliderButton.MouseButton1Down:Connect(function()
    isDragging = true
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = false
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local sliderPosition = math.clamp((input.Position.X - HeightSlider.AbsolutePosition.X) / HeightSlider.AbsoluteSize.X, 0, 1)
        SliderBar.Size = UDim2.new(sliderPosition, 0, 1, 0)
        SliderButton.Position = UDim2.new(sliderPosition, -10, 0, 0)
        
        currentHeight = 5 + (sliderPosition * 25) -- Độ cao từ 5 đến 30
        HeightLabel.Text = "Độ cao: " .. math.floor(currentHeight)
    end
end)

-- Sự kiện nút bay
FlyButton.MouseButton1Click:Connect(function()
    if isFlying then
        -- Dừng bay
        isFlying = false
        if flyConnection then
            flyConnection:Disconnect()
            flyConnection = nil
        end
        FlyButton.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
        FlyButton.Text = "Bay lên đầu NPCs"
    else
        -- Bắt đầu bay
        isFlying = true
        FlyButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        FlyButton.Text = "DỪNG BAY"
        
        flyConnection = RunService.Heartbeat:Connect(function()
            flyToNPC()
        end)
    end
end)

-- Sự kiện toggle auto tool
AutoToolToggle.MouseButton1Click:Connect(function()
    if isAutoToolEnabled then
        -- Tắt auto tool
        isAutoToolEnabled = false
        if autoToolConnection then
            autoToolConnection:Disconnect()
            autoToolConnection = nil
        end
        AutoToolToggle.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        AutoToolToggle.Text = "Auto Tool: TẮT"
    else
        -- Bật auto tool
        isAutoToolEnabled = true
        AutoToolToggle.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        AutoToolToggle.Text = "Auto Tool: BẬT"
        
        autoToolConnection = RunService.Heartbeat:Connect(function()
            if isFlying then
                useToolAutomatically()
            end
        end)
    end
end)

-- Xử lý khi character respawn
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
end)

print("GUI NPC Controller đã được tạo!")
